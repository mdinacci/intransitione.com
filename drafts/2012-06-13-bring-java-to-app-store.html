--- 
layout: post
title: It is time to bring your Java application to the App Store.
tags: 
- Java
- App Store
- Mac
- OpenJDK
---

<p>In this guide I'll go through all the steps required to port your application to OpenJDK with the goal of selling it into the App Store.
Although the App Store guidelines explicitly forbids applications to rely on deprecated or optionally installed technologies (Apple no longer bundles their JDK port so applications can't rely on the user to have it installed), you can still distribute your Java application on the App Store by embedding the <a href="http://openjdk.java.net/">OpenJDK 7 OSX port</a> in a native OSX application.
</p>
<p>Note that this guide is still a work in progress as I still haven't submitted my application nor fixed all the OpenJDK problems I've encountered; I will keep updating it until the submission process will be complete.</p>

<p>Contents:</p>

<ol>
    <li><a href="#tutorial">Tutorial</a></li>
    <li><a href="#knownproblems">Known Problems</a></li>
    <li><a href="#goodies">Goodies</a></li>
</ol>

<p></p>

<a name="#tutorial"></a>
<h2>Tutorial</h2>

<p>It may sounds obvious but the procedure that follows can be performed only on OSX, not from Windows, Linux or any other OS.</p>

<ol>
    <li><a href="#stepone">Gather the requirements</a></li>
    <li><a href="#steptwo">Make your application sandbox-proof</a></li>
    <li><a href="#stepthree">Migrate existing data and preferences</a></li>
    <li><a href="#stepfour">Build and sign a package for your application bundle</a></li>
</ol>

<p></p>

<a name="#stepone"></a>
<h3>Requirements</h3>

<h4>OpenJDK</h4>
<p>First of all, you need to acquire the OpenJDK OSX port. There are 3 ways:</p>

<ul>
    <li> Download the <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle binary distribution</a>.</li>
    <li><a href="http://openjdk.java.net/projects/macosx-port/">Clone the Mercurial repository</a> (look on the left). Compile it with Java 6 or 7 if you already have it.</li>
    <li>Download one of the excellent Henry Gomez's <a href="http://code.google.com/p/openjdk-osx-build/">pre-built packages</a>.</li>
</ul>

<p><strong>Don't know which one to choose ?</strong></p>
<p>Getting the source should be the only reasonable option if you're serious about bringing your application to the App Store. However if you want to get started quickly and are not interested in the bleeding edge version, download the Oracle distribution. If you want the latest version of the code but don't want to build it yourself, download one of the Henry Gomez's pre-built images.</p>
<p>Note that the Oracle bundle and the OpenJDK have different licences, the first is released under the <a href="http://www.oracle.com/technetwork/java/javase/terms/license/index.html">Binary Code License</a> agreement , the second under the <a href="http://openjdk.java.net/legal/gplv2+ce.html">GPL version 2 with Classpath Exception</a>.

<h4>AppBundler</h4>
<p>Once you have finished downloading the OpenJDK you need to install <strong>AppBundler</strong> to package your application.</p>

<p><a href="http://java.net/projects/appbundler" title="Download AppBundler">AppBundler</a> is an ant task so just put the downloaded jar in the <em>lib</em> folder in your ant distribution and then <a href="http://java.net/projects/appbundler/pages/Home" title="AppBundler instructions">follow the instructions</a> to package your application. It still misses many features like the ability to sign your bundle or to register your application with a particular file type but it does a great job in including a Java runtime within the application bundle and building an <strong>Info.plist</strong> file with all the required keys.</p>

<p>Note that some keys are compulsory and your application won't be accepted if they're missing so be sure they're present. You must declare at least:</p>

<ul>
    <li>CFBundleIdentifier</li>
    <li>CFBundleVersion</li>
    <li>NSHumanReadableCopyright</li>
    <li>LSApplicationCategoryType</li>
</ul>

<p>Refer to <a href="https://developer.apple.com/library/mac/#documentation/MacOSX/Conceptual/BPRuntimeConfig/Articles/ConfigFiles.html" title="Apple Documentation">Apple documentation</a> for the meaning of these keys or just follow this example to be sure they're always included:</p> 

{% highlight xml %}

<target name="bundle" depends="...">
    <!-- Import the AppBundlerTaks from ant lib directory -->
    <taskdef name="bundleapp" 
           classname="com.oracle.appbundler.AppBundlerTask"/>

    <bundleapp outputdirectory="."
        name="MyApp"
        displayname="MyApp"
        identifier="com.foobarbaz.MyApp"
        shortversion="1.0"
        icon="MyApp.icns"
        mainclassname="MyAppMain"
        copyright="2012 FooBarBaz LLC."
        applicationCategory="public.app-category.entertainment">

        <!-- The directory where your OpenJDK runtime is. -->
        <runtime dir="/path/to/openjdk/Contents/Home"/>

        <!-- The bundleapp task doesn't support classpathref so all 
            the run classpath entries must be stated here too.
        -->
        <classpath file="MyApp.jar"/>
        <classpath file="dependencies.jar"/>
      
        <!-- Workaround since the icon parameter for bundleapp 
             doesn't work. (It's not a bug in AppBundler but 
             in the JavaAppLauncher, see Known Problems).
        -->
        <option value="-Xdock:icon=Contents/Resources/${bundle.icon}"/>

        <!-- OSX specific options, optional -->
        <option value="-Dapple.laf.useScreenMenuBar=true"/>
        <option value="-Dcom.apple.macos.use-file-dialog-packages=true"/>
        <option value="-Dcom.apple.macos.useScreenMenuBar=true"/>
        <option value="-Dcom.apple.mrj.application.apple.menu.about.name=MyApp"/>
        <option value="-Dcom.apple.smallTabs=true"/>

        <!-- Arguments to the JVM, I found this to be ignored though and I 
            haven't had the time to look more in depth at the issue -->
        <argument value="-Xmx1024M"/>
    </bundleapp>
</target>   

{% endhighlight %}
<p></p>

<a name="#steptwo"></a>
<h3>Make your application sandbox proof</h3>

<p>Starting from the 1st of June all applications submitted to the App Store must be sandbox ready.</p> 
<p>For a comprehensive explanation of what the sandbox is refers to the <a href="http://developer.apple.com/library/mac/#documentation/Security/Conceptual/AppSandboxDesignGuide/AboutAppSandbox/AboutAppSandbox.html">Apple documentation</a>.
In short though, the sandbox is an access control mechanism which restricts interaction of your application with the operating system.</p>

<p>The <em>container</em> is the directory where your application can safely read/write the files required for its correct functioning. It is physically located in <strong><em>~/Library/Containers/yourapp.bundle.id</em></strong>; I doubt this is likely to change anytime soon so if you have a very simple application you <b>may</b> hardcode this path instead of relying on a native library to return it for you. I say may because I can't possibly know how Apple will react if you hardcode the path of the container instead of obtaining it by using the API.</p>

<p>If your application will require storing user documents in the container or writing temporary files and you don't want to risk any surprise you'll have to build a native extension to get the appropriate directories. A JNI wrapper is the easiest route, the only problem I encountered is that <strong>javah</strong> generate headers files with the line: 

{% highlight c %}
#include <jni.h>
{% endhighlight %}

<p>which I had to change to </p>

{% highlight c %}
#include <JavaVM/jni.h>
{% endhighlight %}

<p>Here's a simple Makefile to generate the headers and fix this include line:</p>

{% highlight bash %}
#!/bin/sh

DIST = jni_headers
CP = foobaz.jar
CLASS = com.foobaz.yourclass

all:
    mkdir -p $(DIST)
    javah -jni -d $(DIST) -cp $(CP) $(CLASS)
    sed -i ""  's/jni.h/JavaVM\/jni.h/' $(DIST)/*.h

clean:
    rm *.o *.class
{% endhighlight %}

<p>Now that you have your C header you can create a function that will return for example the <em>Application Support</em> folder for your application, which is located inside the appplication container:</p>

{% highlight c %}
JNIEXPORT jstring JNICALL 
Java_com_foobar_OSXAdapter_getApplicationSupportFolder
(JNIEnv *env, jobject jthis) {
    jstring path;
    
    @autoreleasepool {
        
        JNF_COCOA_ENTER(env);
        
        NSArray *paths = NSSearchPathForDirectoriesInDomains(
                                NSApplicationSupportDirectory, 
                                NSUserDomainMask, YES);
        NSString *basePath = [paths objectAtIndex:0];
        
        // Convert the NSString to a jstring
        const char *cString = [basePath UTF8String];
        path = (*env)->NewStringUTF(env, cString);
        
        JNF_COCOA_EXIT(env);
    }
    
    return path;
}
{% endhighlight %}

<p></p>

<a name="#stepthree"></a>
<h3>Migrate existing application data and preferences</h3>

<p>If you're not releasing a new application chances is that you are already saving your application data and preferences somewhere, most likely in <em>~/Library/Application Support</em>.</p>

<p>There </p>

<a name="#knownproblems"></a>
<h2>Known problems</h2>

<p>Plenty unfortunately. But don't let that discourage you.</p>

<p>Here's a list of most of the problems I've encountered and their solution:</p>

<h4>Launch failure <em>(LSOpenURLsWithRole() failed with error...)</em></h4>

    <p><a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-May/004116.html"/>Mailing list Discussion</a>.</p> 
    <p>This is not a bug in the AppBundler but in the <em>JavaAppLauncher</em> however a workaround is to apply <a href="https://github.com/mdinacci/md_appbundler/blob/master/patches/wrongdirectory.patch">this patch</a> to AppBundler. <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7159381">This is the root problem</a> which should be fixed soon.</p>

<h4>libfreetype absolute reference causes applications inside a sandbox to crash</h4>
    <p><a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-May/004187.html" title="ML discussion">Mailing list discussion</a></p>

    <p>All Swing/AWT apps won't even open because they rely on the freetype lib installed on the user system but the sandbox will immediately block your application the access to it and your application will crash.</p>

    <p>The proper solution would be to fix the OpenJDK makefiles otherwise a quick workaround is to use two nifty tools called <b>otool</b> and <b>install_name_tools</b>:

    <p>First, find out where <em>libfontmanager.dylib</em>,located in the lib directory of your VM, expects to find freetype.</p>

    <p>Open a shell and type:</p>

    {% highlight bash %}
    $ otool -L libfontmanager.dylib
    {% endhighlight %}

    <p>Take note of the libfreetype path, likely <em>/usr/X11/libfreetype.6.dylib</em> unless you have built freetype yourself and installed it somewhere else. Now type:</p>

    {% highlight bash %}
    $ sudo install_name_tool -change /usr/X11/libfreetype.6.dylib @rpath/libfreetype.dylib libfontmanager.dylib
    {% endhighlight %}

    <p>Type again <em>otool -L libfontmanager.dylib</em> and you should see the change.
    We have changed the path to where libfontmanager look for libfreetype to a relative one. So now you have to copy the system or your custom-build freetype library inside the JVM in the same location as libfontmanager.dylib. <br />Relaunch your application, you should at least be able to see it now :)</p>
</li>

<h4><em>segmentedTextured</em> buttons not working</h4>
    <p><a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-May/004073.html" title="ML discussion">Mailing list Discussion.</a></p>
    <p>I didn't find a solution for this, but it seems that increasing the margin around the button make the problem go away. I couldn't afford to have too much empty space though so I just replaced the decorations with an image.</p>

<h4>OpenJDK Universal build not available</h4>
    <a href="http://openjdk-osx-build.googlecode.com/svn/trunk/patches-jdk7u-osx/universal-build.patch">Patch by Henry Gomez.</a>

<h4>AppBundler universal binary</h4>
    <a href="https://github.com/mdinacci/md_appbundler/blob/master/patches/universal_binary.patch">Quick patch (could be improved)</a>

<h4>Dock Icon defaults to Generic Java Application</h4>
    <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7159381">Dock Icon defaults to Generic Java Application</a>
    <p>The (temporary) solution here is to specify both <em>CFBundleIconFile</em> and <em>-Xdock:icon=Contents/Resources/your-icon</em> in your <em>Info.plist</em> file. This could be done easily with AppBundler, I've written an example above.</p>

<h4><em>apple.awt.fileDialogForDirectories</em> property not working.</h4>
    <p><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7161437">Bug report</a>, 
    <a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-May/004295.html">discussion</a> and <a href="http://intransitione.com/code/7161437.patch">my patch</a>.</p>

<h4>JFileChooser broken in the sandbox.</h4>
    <p><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7172752">Bug report</a>  (not available, may Oracle think this is not a bug).
    <a href=""></a>. There is no workaround for this, except to switch to <em>FileDialog</em>.

<h4>Crash when opening an application from a registered file</h4>
<a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7170716" title="Bug">Bug report</a> and <a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-May/004226.html" title="Discussion">Discussion</a>.
    <p>If a user double click on a file to open your application the application will crash before even showing its main window. Oracle judged it a low priority bug, I disagree, I think that if you download for instance a PDF reader and you double-click on a PDF file <strong>the absolute minimum</strong> would be that your application opens...</p>

<h4><em>awt.brush.metalLook</em> is not observed.</h4>
    <p><a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-May/004227.html">Planned to be fixed in jdk7u6</a>.</p>

<h4>Sandbox Violation on Runtime Exec</h4>
    <p><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7175692">Bug description</a> and <a href="http://mail.openjdk.java.net/pipermail/macosx-port-dev/2012-June/004375.html">ML discussion</a>. Because of the sandbox an application can't create a child process; there are a few workarounds but they all involve writing native code.</p>

<h2>Goodies</h2>

<p>I created a <a href="https://github.com/mdinacci/openjdk-osx-starter-kit" title="GitHub repo">git repository</a> with a skeleton project including an ant file and the AppBundler and OpenJDK patches I've used.</p> 

<p>If you have any questions, leave a comment here or on <a href="http://twitter.com/MarcoDinacci">Twitter</a></p>

Marco
